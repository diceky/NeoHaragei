const video=document.getElementById("video"),select=document.getElementById("select"),sliderMasterVolume=document.getElementById("volume"),sliderBpm=document.getElementById("bpm"),sliderLowpass=document.getElementById("lowpass"),sliderHighpass=document.getElementById("highpass"),help=document.getElementById("help"),manual=document.getElementById("manual"),manualClose=document.getElementById("manual-close");let currentStream,beatIsPlaying=!1,faceIsDetected=!1,isSnapCamera=!1;Tone.Destination.volume.value=-20,Tone.Destination.mute=!0;const lowPassfilter=new Tone.Filter(1e4,"lowpass"),highPassfilter=new Tone.Filter(0,"highpass"),autoPanner=new Tone.AutoPanner("8n").start(),delay=new Tone.FeedbackDelay("8n",.5).chain(new Tone.Volume(-15),lowPassfilter,highPassfilter,Tone.Destination),synth1=(new Tone.FMSynth).connect(delay),distortion=new Tone.Distortion(.9).chain(new Tone.Volume(-15),lowPassfilter,highPassfilter,Tone.Destination),synth2=(new Tone.AMSynth).connect(distortion),synth3=(new Tone.DuoSynth).connect(distortion),samplerJapanese=new Tone.Sampler({urls:{C4:"japanese.mp3"},release:1,baseUrl:"/sounds/"}).chain(autoPanner,lowPassfilter,highPassfilter,new Tone.Volume(-12),Tone.Destination),samplerSnapCamera=new Tone.Sampler({urls:{C4:"okinawa.mp3"},release:1,baseUrl:"/sounds/"}).chain(autoPanner,lowPassfilter,highPassfilter,new Tone.Volume(-2),Tone.Destination),samplerFlute=new Tone.Sampler({urls:{A1:"A1.mp3",A2:"A2.mp3"},baseUrl:"https://tonejs.github.io/audio/casio/"}).toDestination(),samplerNeoHaragei=new Tone.Sampler({urls:{C4:"neo-haragei.mp3"},release:1,baseUrl:"/sounds/"}).chain(autoPanner,lowPassfilter,highPassfilter,new Tone.Volume(-2),Tone.Destination),kick=new Tone.Player("/sounds/kick.mp3").chain(lowPassfilter,highPassfilter,new Tone.Volume(-8),Tone.Destination),snare=new Tone.Player("/sounds/snare.mp3").chain(lowPassfilter,highPassfilter,new Tone.Volume(-8),Tone.Destination),hihat=new Tone.Player("/sounds/hihat-closed.wav").chain(lowPassfilter,highPassfilter,new Tone.Volume(-8),Tone.Destination),clap=new Tone.Player("/sounds/clap.mp3").chain(lowPassfilter,highPassfilter,new Tone.Volume(-8),Tone.Destination),yo=new Tone.Player("/sounds/yo_cut.mp3").chain(autoPanner,new Tone.Volume(-8),Tone.Destination),now=Tone.now(),loopKick=new Tone.Loop(e=>{kick.start(e)},"4n").start(0),loopKickDouble=new Tone.Loop(e=>{kick.start(e)},"8n").start(0),loopHihat=new Tone.Loop(e=>{hihat.start(e)},"4n").start("8n"),loopHihatDouble=new Tone.Loop(e=>{hihat.start(e)},"8n").start("8n"),loopHihatRush=new Tone.Loop(e=>{hihat.start(e)},"16n").start(0),loopSnare=new Tone.Loop(e=>{snare.start(e)},"2n").start(0),loopClap=new Tone.Loop(e=>{clap.start(e),clap.start(e+Tone.Time("8n").toSeconds())},"1n").start("14n"),loopClapRush=new Tone.Loop(e=>{clap.start(e)},"8n").start(0),loopSnapCamera=new Tone.Loop(e=>{samplerSnapCamera.triggerAttackRelease(["B4"],"1n",e)},Tone.Time("2m").toSeconds()).start("12n"),loopKabuki=new Tone.Loop(e=>{samplerJapanese.triggerAttackRelease(["Bb4"],"2n",e)},Tone.Time("2m").toSeconds()).start("12n"),loopNeoHaragei=new Tone.Loop(e=>{samplerNeoHaragei.triggerAttackRelease(["B3"],"1n",e)},Tone.Time("1m").toSeconds()).start("12n");function startVideo(){navigator.mediaDevices.getUserMedia({video:{}}).then(e=>(currentStream=e,video.srcObject=e,video.onloadedmetadata=function(e){video.play()},navigator.mediaDevices.enumerateDevices())).then(gotDevices).catch(e=>{console.log(e.name+": "+e.message)})}function getKeysWithHighestValue(e,t){var n=Object.keys(e);return n.sort(function(t,n){return e[n]-e[t]}),n.slice(0,t)}function getTop(e){return e.map(e=>e.y).reduce((e,t)=>Math.min(e,t))}function getMeanPosition(e){return e.map(e=>[e.x,e.y]).reduce((e,t)=>[e[0]+t[0],e[1]+t[1]]).map(t=>t/e.length)}function gotDevices(e){select.innerHTML="";const t=document.createElement("option");t.appendChild(document.createTextNode("Select Camera")),select.appendChild(t);let n=1;e.forEach(e=>{if("videoinput"===e.kind){const t=document.createElement("option");t.value=e.deviceId;const o=e.label||`Camera ${n++}`,a=document.createTextNode(o);t.appendChild(a),select.appendChild(t)}})}function stopMediaTracks(e){e.getTracks().forEach(e=>{e.stop()})}Tone.Transport.bpm.value=120,document.getElementById("btn-start").addEventListener("click",()=>{faceIsDetected&&(document.getElementById("intro").classList.add("hide"),document.getElementById("intro-bg").classList.add("hide"),document.getElementById("btn-play").classList.remove("hide"))}),document.getElementById("btn-play").addEventListener("click",async()=>{beatIsPlaying?(Tone.Transport.stop(),Tone.Destination.mute=!0,beatIsPlaying=!1,document.getElementById("btn-play").innerHTML="PLAY"):(await Tone.start(),console.log("audio is ready"),Tone.Transport.start(),Tone.Destination.mute=!1,beatIsPlaying=!0,document.getElementById("btn-play").innerHTML="STOP")}),help.addEventListener("click",()=>{manual.classList.remove("hide")}),manualClose.addEventListener("click",()=>{manual.classList.add("hide")}),Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri("/models"),faceapi.nets.faceLandmark68Net.loadFromUri("/models"),faceapi.nets.faceRecognitionNet.loadFromUri("/models"),faceapi.nets.faceExpressionNet.loadFromUri("/models")]).then(startVideo),video.addEventListener("play",()=>{let e=document.getElementsByTagName("canvas");null!=e[0]&&e[0].remove();const t=faceapi.createCanvasFromMedia(video);document.body.append(t),t.style.zIndex="1";const n={width:video.width,height:video.height};faceapi.matchDimensions(t,n),setInterval(async()=>{const e=await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions({scoreThreshold:.3})).withFaceLandmarks().withFaceExpressions(),o=faceapi.resizeResults(e,n);if(t.getContext("2d").clearRect(0,0,t.width,t.height),faceapi.draw.drawDetections(t,o),faceapi.draw.drawFaceLandmarks(t,o),faceapi.draw.drawFaceExpressions(t,o),faceIsDetected&&(document.getElementById("btn-start").innerHTML="START HARAGEI",document.getElementById("btn-start").classList.remove("disabled")),void 0===e||0==e.length)console.log("waiting for face ....");else{faceIsDetected=!0;getKeysWithHighestValue(e.expressions,1);var a=e.detection.box.x,s=e.landmarks.positions,i=s[63],r=s[67],l=Math.sqrt(Math.pow(i.x-r.x,2)+Math.pow(i.y-r.y,2)),c=getMeanPosition(e.landmarks.getRightEye()),p=getMeanPosition(e.landmarks.getLeftEye()),d=getMeanPosition(e.landmarks.getNose()),g=getMeanPosition(e.landmarks.getMouth()),h=(getTop(e.landmarks.getJawOutline())-g[1])/e.detection.box.height,m=(p[0]+(c[0]-p[0])/2-d[0])/e.detection.box.width,u=Math.abs(s[20].y-s[38].y);let t=0;isSnapCamera?a<=300?((t=a/300*9e3+1e3)<1e3?t=1e3:t>9e3&&(t=1e4),lowPassfilter.frequency.value=t,document.getElementById("lowpass-content").innerHTML=Math.abs(100-(t-1e3)/90).toFixed(0)+"%"):a>=600&&((t=Math.abs(600-a)/400*5e3)<500?t=0:t>=4e3&&(t=4e3),highPassfilter.frequency.value=t,document.getElementById("highpass-content").innerHTML=(t/40).toFixed(0)+"%"):a<=200?((t=a/200*9e3+1e3)<1e3?t=1e3:t>9e3&&(t=1e4),lowPassfilter.frequency.value=t,document.getElementById("lowpass-content").innerHTML=Math.abs(100-(t-1e3)/90).toFixed(0)+"%"):a>=300&&((t=Math.abs(300-a)/200*5e3)<500?t=0:t>=4e3&&(t=4e3),highPassfilter.frequency.value=t,document.getElementById("highpass-content").innerHTML=(t/40).toFixed(0)+"%"),m<.04&&m>-.04?isSnapCamera?l<40?(synth1.triggerRelease(),synth2.triggerRelease(),samplerFlute.triggerRelease()):l<42&&l>=40?synth1.triggerAttack("C4",now):l<44&&l>=42?synth1.triggerAttack("E4",now):l<46&&l>=44?synth1.triggerAttack("F4",now):l<48&&l>=46?synth1.triggerAttack("G4",now):l>=48&&synth1.triggerAttack("B4",now):l<20?(synth1.triggerRelease(),synth2.triggerRelease(),samplerFlute.triggerRelease()):l<22&&l>=20?synth1.triggerAttack("C4",now):l<24&&l>=22?synth1.triggerAttack("E4",now):l<26&&l>=24?synth1.triggerAttack("F4",now):l<28&&l>=26?synth1.triggerAttack("G4",now):l>=28&&synth1.triggerAttack("B4",now):m>=.04?isSnapCamera?l<40?(synth1.triggerRelease(),synth2.triggerRelease(),synth3.triggerRelease()):l<42&&l>=40?synth2.triggerAttack("D2",now):l<44&&l>=42?synth2.triggerAttack("F2",now):l<46&&l>=44?synth2.triggerAttack("A2",now):l<48&&l>=46?synth2.triggerAttack("B2",now):l>=48&&synth2.triggerAttack("C3",now):l<20?(synth1.triggerRelease(),synth2.triggerRelease(),synth3.triggerRelease()):l<22&&l>=20?synth2.triggerAttack("D2",now):l<24&&l>=22?synth2.triggerAttack("F2",now):l<26&&l>=24?synth2.triggerAttack("A2",now):l<28&&l>=26?synth2.triggerAttack("B2",now):l>=28&&synth2.triggerAttack("C3",now):m<=-.04&&(isSnapCamera?l<40?(synth1.triggerRelease(),synth2.triggerRelease(),synth3.triggerRelease()):l<42&&l>=40?synth3.triggerAttack("E4",now):l<44&&l>=42?synth3.triggerAttack("G4",now):l<46&&l>=44?synth3.triggerAttack("B4",now):l<48&&l>=46?synth3.triggerAttack("C5",now):l>=48&&synth3.triggerAttack("E5",now):l<20?(synth1.triggerRelease(),synth2.triggerRelease(),synth3.triggerRelease()):l<22&&l>=20?synth3.triggerAttack("E5",now):l<24&&l>=22?synth3.triggerAttack("G4",now):l<26&&l>=24?synth3.triggerAttack("B5",now):l<28&&l>=26?synth3.triggerAttack("C6",now):l>=28&&synth3.triggerAttack("E6",now)),document.getElementById("mouthSize").innerHTML="Mouth Size: "+l,document.getElementById("headRotationX").innerHTML="Head Rotation X: "+h,Math.abs(m)<.02?(loopKabuki.stop(),loopSnapCamera.stop(),"stopped"==loopNeoHaragei.state&&loopNeoHaragei.start("12n"),loopKick.stop(),loopSnare.stop(),loopKickDouble.stop(),loopHihatDouble.stop(),loopHihatRush.stop(),loopClapRush.stop(),"stopped"==loopHihat.state&&loopHihat.start(0),document.getElementById("sampling-content").innerHTML="NEO HARAGEI"):Math.abs(m)<.04?("stopped"==loopKabuki.state&&loopKabuki.start("12n"),loopSnapCamera.stop(),loopNeoHaragei.stop(),loopKickDouble.stop(),loopHihatDouble.stop(),loopHihatRush.stop(),loopClapRush.stop(),"stopped"==loopKick.state&&loopKick.start(0),"stopped"==loopSnare.state&&loopSnare.start(0),document.getElementById("sampling-content").innerHTML="KABUKI"):Math.abs(m)<.06?(loopKabuki.stop(),loopNeoHaragei.stop(),"stopped"==loopSnapCamera.state&&loopSnapCamera.start("12n"),loopKick.stop(),loopHihat.stop(),loopClapRush.stop(),loopHihatRush.stop(),"stopped"==loopKickDouble.state&&loopKickDouble.start(0),"stopped"==loopHihatDouble.state&&loopHihatDouble.start(0),document.getElementById("sampling-content").innerHTML="OKINAWA"):(loopKabuki.stop(),loopNeoHaragei.stop(),loopSnapCamera.stop(),loopKickDouble.stop(),loopHihatDouble.stop(),"stopped"==loopHihatDouble.state&&loopHihatRush.start(0),"stopped"==loopClapRush.state&&loopClapRush.start(0),document.getElementById("sampling-content").innerHTML="none"),document.getElementById("eyebrow").innerHTML="Right Eyebrow Height: "+u,isSnapCamera?u>60&&"stopped"==yo.state&&yo.start("@4n"):u>25&&"stopped"==yo.state&&yo.start("@4n"),document.getElementById("transport").innerHTML="Tone.Transport: "+Tone.Transport.position}},100)}),select.addEventListener("change",()=>{void 0!==currentStream&&stopMediaTracks(currentStream);var e={video:{deviceId:{exact:select.value}}};navigator.mediaDevices.getUserMedia(e).then(e=>{currentStream=e,video.srcObject=e,video.onloadedmetadata=function(e){video.play()}}).catch(e=>{console.log(e.name+": "+e.message)}),"Snap Camera"==select.options[select.selectedIndex].text?(isSnapCamera=!0,video.width=975,video.height=560):(isSnapCamera=!1,video.width=720,video.height=560)}),sliderMasterVolume.addEventListener("change",()=>{Tone.Destination.volume.value=sliderMasterVolume.value}),sliderBpm.addEventListener("change",()=>{Tone.Transport.bpm.value=sliderBpm.value});